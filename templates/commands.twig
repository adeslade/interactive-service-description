{% extends 'layout.twig' %}

{% block title %}{{ descriptionName }}{% endblock %}

{% block content %}

<div class="header--compact" role="banner">
    <div class="container">
        <h1 class="header__title--home" id="home-title">Search endpoints</h1>

        <form class="search-form js-search-form">
            <input
                aria-labelledby="home-title"
                class="search-form__input js-search-endpoints"
                placeholder="e.g. get users"
                type="search"
            >
            <button class="search-form__reset" type="reset" tabindex="-1">
                <span class="search-form__reset-label">Clear</span>
            </button>
        </form>
    </div>
</div>

<div role="main">

    <div class="container--medium js-results" hidden>
        <ol class="endpoint-list js-endpoint-results"></ol>
        {% include 'footer.twig' %}
    </div>

    <div class="js-directory">
        <div class="container">
            <h1 class="section-title--centered">Endpoints A-Z</h1>

            <ol class="card__list--fading">
                {% for resource in baseResources|slice(0, 9) %}
                    <li class="card">
                        <a href="/directory/{{ resource }}.html" class="card__link">
                            <h2 class="card__title">{{ resource|split("-")|join(" ")|capitalize }}</h2>
                            <p class="card__description">/{{ resource }}</p>
                        </a>
                    </li>
                {% endfor %}
            </ol>
        </div>

        <div class="feature-block">
            <p class="feature-block__copy">Visit the directory for an overview of all endpoints</p>
            <a class="feature-block__cta" href="/directory">Explore</a>
        </div>
    </div>

</div>

<script type="text/template" id="template">
    <a href="<%= path %>" class="endpoint-list__item-link" tabindex="0">
        <div class="endpoint-list__item-header endpoint-method-<%= method %>">
            <h2 class="endpoint-list__item-title"><%= formattedTitle %></h2>
            <% if (summary) { %>
                <p class="endpoint-list__item-summary"><%= summary %></p>
            <% } %>
        </div>
        <div class="endpoint-list__item-footer">
            <span class="endpoint-list__item-resource"><%= method %> <%= formattedUri %></span>
        </div>
    </a>
</script>

<script>
    var searchFormEl = document.querySelector('.js-search-form'),
        searchEl = document.querySelector('.js-search-endpoints'),
        resultsEl = document.querySelector('.js-results'),
        resultListEl = document.querySelector('.js-endpoint-results'),
        directoryEl = document.querySelector('.js-directory'),
        templateEl = document.querySelector('#template'),
        template = _.template(templateEl.innerHTML),
        results = [];

    commands = new Bloodhound({
        datumTokenizer: function (d) {
            return d.tokens;
        },
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
            url: '/data/commands.json',
            thumbprint: {{ generated|date('U', 'UTC') }}
        },
        limit: 16,
    });
    commands.initialize();

    searchFormEl.addEventListener('reset', function () {
        this.classList.remove('is-non-empty');
        resultListEl.innerHTML = '';
        directoryEl.removeAttribute('hidden');
        resultsEl.setAttribute('hidden', true);
    }, false);

    searchEl.addEventListener('keyup', function (evt) {
        var q = this.value;

        if (q.length) {
            searchFormEl.classList.add('is-non-empty');
            directoryEl.setAttribute('hidden', true);
            resultsEl.removeAttribute('hidden');
        } else {
            searchFormEl.classList.remove('is-non-empty');
            directoryEl.removeAttribute('hidden');
            resultsEl.setAttribute('hidden', true);
        }

        resultListEl.innerHTML = '';
        commands.get(q, function (suggestions) {
            _.each(suggestions, function (suggestion) {
                result = document.createElement('li');
                result.className = 'endpoint-list__item';
                result.innerHTML = template(suggestion);
                resultListEl.appendChild(result);
            });
        });
    }, false);

</script>

{% endblock %}
